{% extends "base.html" %}
{% block content %}

<div class="tables-shell">
  <div class="tables-layout">

    <!-- LEFT COLUMN: controls + results (scroll independiente) -->
    <div class="tables-left">

      <div class="card panel-section">
        <div class="card-header">
          <div>
            <h1 class="h1">Relaciones curriculares</h1>
            <p class="p-muted">
              Elige asignatura, busca códigos y genera las tablas en vivo.
            </p>
          </div>
        </div>

        <div class="divider"></div>

        <form id="tables-form"
              hx-post="{% url 'generator:tables_render' %}"
              hx-target="#tables-dynamic"
              hx-swap="innerHTML"
              hx-trigger="change from:select">

          {% csrf_token %}

          <div class="stack stack-loose">

            <div class="field">
              <label>Asignatura</label>
              <select name="subject_id">
                <option value="">-- Selecciona --</option>
                {% for s in subjects %}
                  <option value="{{ s.id }}"
                    {% if selected_subject and selected_subject.id == s.id %}selected{% endif %}>
                    {{ s.name }}{% if demo_mode and demo_subject_id and s.id|stringformat:"s" == demo_subject_id|stringformat:"s" %} - *DEMO*{% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label>Buscar código</label>
              <input class="input"
                     type="text"
                     name="q"
                     placeholder="Ej: A. / GEH.1.A. / 1.1..."
                     autocomplete="off"
                     hx-post="{% url 'generator:tables_search' %}"
                     hx-target="#code-results"
                     hx-swap="innerHTML"
                     hx-trigger="keyup changed delay:200ms"
                     hx-include="#tables-form">
            </div>

            <div class="row">
              <button class="btn btn-primary"
                      type="submit"
                      formaction="{% url 'generator:tables_export' %}"
                      formmethod="post"
                      {% if demo_mode %}disabled title="Disponible con acceso. Envía un email a pabcadmon@gmail.com para más información."{% endif %}>
                Descargar Excel
              </button>
              <a class="btn btn-ghost"
                 href="{% url 'generator:my_exports' %}">
                Ver exportaciones
              </a>
            </div>

          </div>

          <!-- hidden selected inputs -->
          <div id="selected-codes" style="display:none;"></div>
        </form>
      </div>

      <!-- RESULTS -->
      <div class="results-box panel-section">
        <div class="help" style="margin-bottom: 8px;">
          Pulsa en un código para añadir o quitar.
        </div>
        <div id="code-results">
          <p class="p-muted">Escribe para buscar códigos.</p>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN: generated tables (scroll independiente) -->
    <div class="tables-right">
      <div id="tables-dynamic"
           data-add-url="{% url 'generator:tables_selected_add' %}"
           data-remove-url="{% url 'generator:tables_selected_remove' %}">
        {% include "generator/_tables_tables.html" %}
      </div>
    </div>

  </div>
</div>

<!-- HTMX watchers (NO TOCAR) -->
<div hx-post="{% url 'generator:tables_search' %}"
     hx-include="#tables-form"
     hx-target="#code-results"
     hx-swap="innerHTML"
     hx-trigger="codesChanged from:body">
</div>

<div hx-post="{% url 'generator:tables_render' %}"
     hx-include="#tables-form"
     hx-target="#tables-dynamic"
     hx-swap="innerHTML"
     hx-trigger="codesChanged from:body">
</div>

<div hx-post="{% url 'generator:tables_search' %}"
     hx-include="#tables-form"
     hx-target="#code-results"
     hx-swap="innerHTML"
     hx-trigger="change from:select[name='subject_id']">
</div>

<script>
  const TABLES_STATE_KEY = 'tables-state-v1';

  function readTablesState() {
    try {
      return JSON.parse(localStorage.getItem(TABLES_STATE_KEY) || '{}');
    } catch (err) {
      return {};
    }
  }

  function writeTablesState(next) {
    localStorage.setItem(TABLES_STATE_KEY, JSON.stringify(next));
  }

  function escapeAttr(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function getSelectedCodesFromDom() {
    return Array.from(document.querySelectorAll('#selected-codes input[name="codes"]'))
      .map(input => input.value)
      .filter(Boolean);
  }

  function setSelectedCodesToDom(codes) {
    const container = document.getElementById('selected-codes');
    if (!container) {
      return;
    }
    container.innerHTML = (codes || [])
      .map(code => `<input type="hidden" name="codes" value="${escapeAttr(code)}">`)
      .join('');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const subjectSelect = document.querySelector('select[name="subject_id"]');
    if (!subjectSelect) {
      return;
    }

    const state = readTablesState();
    if (state.subject_id && subjectSelect.querySelector(`option[value="${state.subject_id}"]`)) {
      subjectSelect.value = state.subject_id;
      if (Array.isArray(state.codes) && state.codes.length) {
        setSelectedCodesToDom(state.codes);
      }
      subjectSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }

    subjectSelect.addEventListener('change', () => {
      const next = readTablesState();
      next.subject_id = subjectSelect.value || '';
      next.codes = [];
      writeTablesState(next);
      setSelectedCodesToDom([]);
    });
  });

  document.body.addEventListener('htmx:afterSwap', (event) => {
    if (event.target && event.target.id === 'selected-codes') {
      const next = readTablesState();
      next.codes = getSelectedCodesFromDom();
      writeTablesState(next);
    }
  });
</script>

{% endblock %}
