{% if error %}
  <div class="table-card{% if demo_mode %} demo-watermark{% endif %}">
    <h3>Error</h3>
    <pre>{{ error }}</pre>
  </div>
{% endif %}

{% if table1 and not only_table2 %}
  <div class="table-card{% if demo_mode %} demo-watermark{% endif %}">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">Relaciones por tipo</h3>
      <div style="display: flex; gap: 0.5rem;">
        <button onclick="copyTableToClipboard('table1')" class="btn-small">ðŸ“‹ Copiar</button>
        <button onclick="exportTableToCSV('table1', 'relaciones-por-tipo')" class="btn-small">ðŸ“¥ Exportar</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="nice-table" id="table1">
        <thead>
          <tr>
            {% for h in table1.headers %}<th class="{% if h == 'Tipo' %}col-tipo{% endif %}">{{ h }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in table1.rows %}
            <tr>
              {% for cell in row %}
                <td class="{% if table1.tipo_idx != -1 and forloop.counter0 == table1.tipo_idx %}col-tipo{% endif %}">{{ cell|safe }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

{% if table2_ssbb or table2_ce or table2_cev or table2_do or table2_selected %}
  {% if only_table2 %}
    <div class="table-card{% if demo_mode %} demo-watermark{% endif %}" data-relations-scope="secuenciaciÃ³n">
      {% if selected_codes is not None %}
        {{ selected_codes|json_script:"selected-codes-json" }}
      {% else %}
        <script id="selected-codes-json" type="application/json">[]</script>
      {% endif %}
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Relaciones individuales</h3>
      </div>
      <div class="table-scroll">
        <table class="nice-table current-relations-table">
          <thead>
            <tr>
              {% for h in table2_selected.headers %}<th>{{ h }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in table2_selected.rows %}
              <tr>
                {% for cell in row %}
                  <td>{{ cell|safe }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="table-card{% if demo_mode %} demo-watermark{% endif %}">
      {% if selected_codes is not None %}
        {{ selected_codes|json_script:"selected-codes-json" }}
      {% else %}
        <script id="selected-codes-json" type="application/json">[]</script>
      {% endif %}
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Relaciones individuales</h3>
        <div style="display: flex; gap: 0.5rem;">
          <button onclick="copyTableToClipboard('current-relations-table')" class="btn-small">Copiar</button>
          <button onclick="exportTableToCSV('current-relations-table', 'relaciones-individuales')" class="btn-small">Exportar</button>
        </div>
      </div>
      
      <!-- Desplegable para seleccionar tipo -->
      <div class="dropdown-section" style="margin-bottom: 1rem;">
        <label for="code-type-selector">Selecciona tipo de cÃ³digo:</label>
        <select id="code-type-selector" onchange="window.RelationsTableUI && window.RelationsTableUI.switchTable(this.value)">
          <option value="ssbb" {% if table2_ssbb %}selected{% endif %}>SSBB (Saberes Basicos)</option>
          <option value="ce" {% if table2_ce and not table2_ssbb %}selected{% endif %}>CE (Competencias EspecÃ­ficas)</option>
          <option value="cev" {% if table2_cev and not table2_ssbb and not table2_ce %}selected{% endif %}>CEv (Criterios de EvaluaciÃ³n)</option>
          <option value="do" {% if table2_do and not table2_ssbb and not table2_ce and not table2_cev %}selected{% endif %}>DO (Descriptores Operativos)</option>
        </select>
      </div>

      <!-- Tabla SSBB -->
      {% if table2_ssbb %}
        <div id="table-ssbb" class="table-relations-content">
          <div class="table-scroll">
            <table class="nice-table current-relations-table">
              <thead>
                <tr>
                  {% for h in table2_ssbb.headers %}<th>{{ h }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in table2_ssbb.rows %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell|safe }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      <!-- Tabla CE -->
      {% if table2_ce %}
        <div id="table-ce" class="table-relations-content" style="display: none;">
          <h4>CE relacionados</h4>
          <div class="table-scroll">
            <table class="nice-table current-relations-table">
              <thead>
                <tr>
                  {% for h in table2_ce.headers %}<th>{{ h }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in table2_ce.rows %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell|safe }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      <!-- Tabla CEv -->
      {% if table2_cev %}
        <div id="table-cev" class="table-relations-content" style="display: none;">
          <h4>CEv relacionados</h4>
          <div class="table-scroll">
            <table class="nice-table current-relations-table">
              <thead>
                <tr>
                  {% for h in table2_cev.headers %}<th>{{ h }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in table2_cev.rows %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell|safe }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      <!-- Tabla DO -->
      {% if table2_do %}
        <div id="table-do" class="table-relations-content" style="display: none;">
          <h4>DO relacionados</h4>
          <div class="table-scroll">
            <table class="nice-table current-relations-table">
              <thead>
                <tr>
                  {% for h in table2_do.headers %}<th>{{ h }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in table2_do.rows %}
                  <tr>
                    {% for cell in row %}
                      <td>{{ cell|safe }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <script>
    (function(){
      if (!window.RelationsTableUI) {
        var RELATIONS_STORAGE_KEY = 'relations-table-type';

        function switchRelationsTable(type, persist) {
          if (persist === undefined) persist = true;
          // Ocultar todas las tablas
          var tables = document.querySelectorAll('.table-relations-content');
          tables.forEach(function(table){ table.style.display = 'none'; });
          
          // Mostrar la tabla seleccionada
          var selectedTable = document.getElementById('table-' + type);
          if (!selectedTable && tables.length) {
            selectedTable = tables[0];
            type = selectedTable.id.replace('table-', '');
          }
          if (selectedTable) {
            selectedTable.style.display = 'block';
          }

          var selector = document.getElementById('code-type-selector');
          if (selector && type && selector.value !== type) {
            selector.value = type;
          }
          if (persist && type) {
            localStorage.setItem(RELATIONS_STORAGE_KEY, type);
          }
          markRelationsErrors();
        }

        function initRelationsTablePersistence() {
          var selector = document.getElementById('code-type-selector');
          if (!selector) {
            var tables = document.querySelectorAll('.table-relations-content');
            tables.forEach(function(table){ table.style.display = 'none'; });
            if (tables.length) {
              tables[0].style.display = 'block';
            }
            markRelationsErrors();
            return;
          }
          var savedType = localStorage.getItem(RELATIONS_STORAGE_KEY);
          var initialType = (savedType && document.getElementById('table-' + savedType))
            ? savedType
            : selector.value;
          switchRelationsTable(initialType, false);
        }

        function markRelationsErrors() {
          if (window.RelationsTable && window.RelationsTable.mark) {
            window.RelationsTable.mark(document);
          }
        }

        window.RelationsTableUI = {
          init: initRelationsTablePersistence,
          switchTable: switchRelationsTable
        };

        if (!window.__relationsTableHtmxHook) {
          window.__relationsTableHtmxHook = true;
          document.body.addEventListener('htmx:afterSwap', function(event){
            if (event.target && event.target.id === 'tables-dynamic') {
              initRelationsTablePersistence();
            }
          });
        }
      }

      window.RelationsTableUI.init();
      if (window.RelationsTable && window.RelationsTable.mark) {
        window.RelationsTable.mark(document);
      }
    })();
  </script>
{% endif %}

{% if table3 and not only_table2 %}
  <div class="table-card{% if demo_mode %} demo-watermark{% endif %}">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">Descripciones de elementos mostrados</h3>
      <div style="display: flex; gap: 0.5rem;">
        <button onclick="copyTableToClipboard('table3')" class="btn-small">ðŸ“‹ Copiar</button>
        <button onclick="exportTableToCSV('table3', 'descripciones')" class="btn-small">ðŸ“¥ Exportar</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="nice-table" id="table3">
        <thead>
          <tr>
            {% for h in table3.headers %}<th>{{ h }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in table3.rows %}
            <tr>
              {% for cell in row %}
                <td>{{ cell|safe }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<script>
  function copyTableToClipboard(tableId) {
    let table;
    if (tableId === 'current-relations-table') {
      // Para la tabla de relaciones, obtener la visible
      const visibleDiv = document.querySelector('.table-relations-content:not([style*="display: none"])');
      if (!visibleDiv) {
        alert('No hay tabla visible para copiar');
        return;
      }
      table = visibleDiv.querySelector('table');
    } else {
      table = document.getElementById(tableId);
    }
    
    if (!table) {
      alert('Tabla no encontrada');
      return;
    }
    
    let csvContent = '';
    const rows = table.querySelectorAll('tr');
    
    rows.forEach((row, rowIndex) => {
      const cells = row.querySelectorAll('th, td');
      const rowData = Array.from(cells).map(cell => {
        // Limpiar HTML si existe
        let text = cell.textContent.trim();
        // Escapar comillas y saltos de lÃ­nea
        text = text.replace(/"/g, '""').replace(/\n/g, ' ');
        // Si contiene comas, espacios o comillas, envolver entre comillas
        if (text.includes(',') || text.includes('"') || text.includes(' ')) {
          text = `"${text}"`;
        }
        return text;
      });
      csvContent += rowData.join('\t') + '\n';
    });
    
    // Copiar al portapapeles
    navigator.clipboard.writeText(csvContent).then(() => {
      alert('Â¡Tabla copiada al portapapeles!');
    }).catch(() => {
      // Fallback para navegadores antiguos
      const textarea = document.createElement('textarea');
      textarea.value = csvContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      alert('Â¡Tabla copiada al portapapeles!');
    });
  }

  function exportTableToCSV(tableId, filename) {
    let table;
    if (tableId === 'current-relations-table') {
      // Para la tabla de relaciones, obtener la visible
      const visibleDiv = document.querySelector('.table-relations-content:not([style*="display: none"])');
      if (!visibleDiv) {
        alert('No hay tabla visible para exportar');
        return;
      }
      table = visibleDiv.querySelector('table');
    } else {
      table = document.getElementById(tableId);
    }
    
    if (!table) {
      alert('Tabla no encontrada');
      return;
    }
    
    let csvContent = 'data:text/csv;charset=utf-8,';
    const rows = table.querySelectorAll('tr');
    
    rows.forEach((row, rowIndex) => {
      const cells = row.querySelectorAll('th, td');
      const rowData = Array.from(cells).map(cell => {
        // Limpiar HTML si existe
        let text = cell.textContent.trim();
        // Escapar comillas y saltos de lÃ­nea
        text = text.replace(/"/g, '""').replace(/\n/g, ' ');
        // Si contiene comas, espacios o comillas, envolver entre comillas
        if (text.includes(',') || text.includes('"') || text.includes(' ')) {
          text = `"${text}"`;
        }
        return text;
      });
      csvContent += rowData.join(',') + '\n';
    });
    
    // Crear enlace de descarga
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${filename}-${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
