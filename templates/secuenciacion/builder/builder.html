{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="secuenciacion-page">

  <h1 style="margin: 0 0 12px 0;">Generar Secuenciación</h1>

  <!-- ASIGNATURA -->
  <div class="card" style="margin-bottom:14px;">
    <div style="display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap;">
      <div style="min-width:260px;">
        <label style="font-size:12px; color:#666; margin-bottom:6px;">Asignatura</label>
        <select id="subjectSelect" style="min-width:320px;">
          <option value="">Selecciona...</option>
          {% for s in subjects %}
            <option value="{{ s.id }}">
              {{ s.name }}{% if demo_mode and demo_subject_id and s.id|stringformat:"s" == demo_subject_id|stringformat:"s" %} - *DEMO*{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div style="min-width:280px;">
        <label style="font-size:12px; color:#666; margin-bottom:6px;">Secuenciación</label>
        <div id="secuenciacionList"
             style="display:flex; flex-wrap:wrap; gap:6px; max-width:520px;">
        </div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
          <button id="createsecuenciacionBtn" type="button">Nuevo</button>
          <button id="deletesecuenciacionBtn" type="button">Borrar</button>
          <button id="renamesecuenciacionBtn" type="button">Cambiar nombre</button>
        </div>
        <div id="secuenciacionStatus" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- GRID PRINCIPAL -->
  <div id="secuenciacionGrid" class="secuenciacion-grid" style="display:none;">

    <!-- IZQUIERDA: CÓDIGOS -->
    <div class="card">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <h2 style="margin:0; font-size:16px;">Saberes y Criterios</h2>
        <span id="leftStatus" style="font-size:12px; color:#666;"></span>
      </div>

      <div id="leftLocked" style="color:#666;">
        Crea una unidad didáctica y selecciónala para ver los saberes básicos y criterios.
      </div>

      <div id="leftPane" style="display:none;">
        <div style="margin-bottom:10px; color:#666;">
          Añadiendo a: <b id="activeUnitName"></b>
        </div>

        <!-- Scroll vertical -->
        <div id="leftCodes"
             style="max-height:560px; overflow-y:auto; overflow-x:hidden;">
          <!-- Scroll horizontal (ANTI-SHRINK) -->
          <div class="codes-scroll">
            <div style="color:#666;">Cargando…</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DERECHA: UNIDADES -->
    <div class="card">
      <div style="display:flex; align-items:center; gap:10px;">
        <h2 style="margin:0; font-size:16px;">Unidades didácticas</h2>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button id="createUnitBtn" type="button">Crear unidad</button>
          <button id="analyzeBtn" type="button">Analizar</button>
        </div>
      </div>

      <div id="rightHint" style="margin-top:10px; color:#666;">
        Crear unidades para comenzar.
      </div>

      <div id="unitsCards"
           style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      </div>

      </div>

    <!-- RIGHT: ANALISIS -->
    <div id="analysisPane" class="card">
      <div style="display:flex; align-items:center; gap:10px;">
        <h2 id="analysisTitle" style="margin:0; font-size:16px;">Análisis: Secuenciación</h2>
        <button id="analysisClose" type="button" style="margin-left:auto;">X</button>
      </div>

      <div id="analysisBox" style="margin-top:12px; display:none;">
        <div id="analysisSummary" class="analysis-summary" style="display:none;"></div>
        <div id="analysisStatus" class="analysis-status" style="display:none;"></div>
        <div id="analysisErrors" class="analysis-errors" style="display:none;"></div>

        <div class="table-scroll" style="margin-bottom:12px;">
          <table class="nice-table">
            <thead>
              <tr>
                <th colspan="2">Elementos usados</th>
              </tr>
              <tr>
                <th>SSBB</th>
                <th>CE</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><div id="usedSsbb" class="code-tag-list"></div></td>
                <td><div id="usedCev" class="code-tag-list"></div></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-scroll">
          <table class="nice-table">
            <thead>
              <tr>
                <th colspan="2">Elementos faltantes</th>
              </tr>
              <tr>
                <th>SSBB</th>
                <th>CE</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><div id="missingSsbb" class="code-tag-list"></div></td>
                <td><div id="missingCev" class="code-tag-list"></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>


  </div>
</div>

<div id="secuenciacionModal" class="modal" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div id="secuenciacionModalTitle" class="modal-title">Nuevo Secuenciación</div>
    <label class="modal-label">Nombre</label>
    <input id="secuenciacionModalName" class="input" placeholder="Nombre del Secuenciación" />
    <div class="modal-actions">
      <button id="secuenciacionModalCancel" type="button">Cancelar</button>
      <button id="secuenciacionModalCreate" type="button" class="btn-primary">Crear</button>
    </div>
  </div>
</div>

<script>
(function(){

  var isDemo = {{ demo_mode|yesno:"true,false" }};
  var demoSubjectId = "{{ demo_subject_id }}";
  var DEMO_MAX_UNITS = 3;
  var DEMO_MAX_CODES = 5;
  var DEMO_STORAGE_KEY = "secuenciacion.demo.state";

  var state = {
    subjectId: "",
    units: [],
    activeUnitId: null,
    secuenciacionId: null,
    secuenciacionName: "",
    isHydrating: false,
    saveTimer: null
  };
  var relationsState = {};
  var relationsRefreshPromise = null;

  function qs(id){ return document.getElementById(id); }

  function csrfToken(){
    var m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : "";
  }

  function uid(){
    return "u_" + Math.random().toString(16).slice(2);
  }

  function readDemoState(){
    try {
      var raw = localStorage.getItem(DEMO_STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch (e) {
      return null;
    }
  }

  function writeDemoState(){
    try {
      localStorage.setItem(DEMO_STORAGE_KEY, JSON.stringify({
        subjectId: state.subjectId || "",
        secuenciacionId: state.secuenciacionId || "demo",
        secuenciacionName: state.secuenciacionName || "",
        activeUnitId: state.activeUnitId || "",
        units: Array.isArray(state.units) ? state.units : []
      }));
    } catch (e) {}
  }

  function clearDemoState(){
    try { localStorage.removeItem(DEMO_STORAGE_KEY); } catch (e) {}
  }

  function applyDemoState(data){
    if (!data) return;
    if (data.subjectId && state.subjectId && data.subjectId !== state.subjectId) return;
    state.secuenciacionId = data.secuenciacionId || "demo";
    state.secuenciacionName = data.secuenciacionName || "";
    state.units = Array.isArray(data.units) ? data.units : [];
    var hasUnit = state.units.some(u => String(u.id) === String(data.activeUnitId));
    state.activeUnitId = hasUnit ? data.activeUnitId : (state.units[0] ? state.units[0].id : null);
    syncPanelsVisibility();
    updateAnalysisTitle();
    if (state.activeUnitId) {
      setActiveUnit(state.activeUnitId);
    } else {
      renderUnits();
      setLeftLocked(true);
    }
  }

  var storage = {
    subjectKey: "secuenciacion.subjectId",
    planKeyPrefix: "secuenciacion.planId."
  };

  function getStoredSubjectId(){
    try { return localStorage.getItem(storage.subjectKey) || ""; } catch(e){ return ""; }
  }

  function setStoredSubjectId(id){
    try { localStorage.setItem(storage.subjectKey, id || ""); } catch(e){}
  }

  function getStoredPlanId(subjectId){
    if(!subjectId) return "";
    try { return localStorage.getItem(storage.planKeyPrefix + subjectId) || ""; } catch(e){ return ""; }
  }

  function setStoredPlanId(subjectId, planId){
    if(!subjectId) return;
    try { localStorage.setItem(storage.planKeyPrefix + subjectId, planId || ""); } catch(e){}
  }

  function setLeftLocked(locked){
    qs("leftLocked").style.display = locked ? "block" : "none";
    qs("leftPane").style.display   = locked ? "none"  : "block";
    document.body.classList.toggle("secuenciacion-left-open", !locked);
  }

  function showAnalysisPane(show){
    var grid = qs("secuenciacionGrid");
    if(show){
      grid.classList.add("is-analysis");
    } else {
      grid.classList.remove("is-analysis");
    }
    if (window.CodeResultsColumns){
      window.CodeResultsColumns.layout(qs("leftCodes"));
    }
  }

  function setsecuenciacionStatus(text){
    qs("secuenciacionStatus").textContent = text || "";
  }

  function syncPanelsVisibility(){
    var grid = qs("secuenciacionGrid");
    if (!grid) return;
    grid.style.display = state.secuenciacionId ? "" : "none";
  }

  function updateAnalysisTitle(){
    var u = activeUnit();
    var name = u && u.name ? u.name : (state.secuenciacionName || "Secuenciación");
    qs("analysisTitle").textContent = "Análisis: " + name;
  }

  function rendersecuenciacionList(items){
    var list = qs("secuenciacionList");
    list.innerHTML = "";
    if(!items || !items.length){
      var empty = document.createElement("span");
      empty.className = "small-muted";
      empty.textContent = "Sin secuenciaciones";
      list.appendChild(empty);
      return;
    }

    items.forEach(item => {
      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn-small";
      btn.dataset.id = item.id;
      btn.textContent = item.name;
      if(String(item.id) === String(state.secuenciacionId)){
        btn.classList.add("btn-primary");
      }
      btn.onclick = async () => {
        setStoredPlanId(state.subjectId, item.id);
        setsecuenciacionStatus("Cargando...");
        await loadsecuenciacion(item.id);
        rendersecuenciacionList(items);
      };
      list.appendChild(btn);
    });
  }

  function updateActivesecuenciacionButtonName(name){
    if(!state.secuenciacionId) return;
    var list = qs("secuenciacionList");
    var btn = list.querySelector("button[data-id='" + state.secuenciacionId + "']");
    if(btn) btn.textContent = name;
  }

  function syncsecuenciacionControls(){
    var hasSubject = !!state.subjectId;
    var hassecuenciacion = !!state.secuenciacionId;
    qs("createsecuenciacionBtn").disabled = !hasSubject;
    qs("deletesecuenciacionBtn").disabled = !hasSubject || !hassecuenciacion;
    qs("renamesecuenciacionBtn").disabled = !hasSubject || !hassecuenciacion;
    qs("analyzeBtn").disabled = !hasSubject;
  }

  function activeUnit(){
    return state.units.find(u => u.id === state.activeUnitId) || null;
  }

  function setActiveUnit(id){
    state.activeUnitId = id;
    var u = activeUnit();
    if(!u){
      setLeftLocked(true);
      return;
    }
    qs("activeUnitName").textContent = u.name || "Sin nombre";
    setLeftLocked(false);
    loadLeftCodes();
    renderUnits();
    if (relationsState[id] && relationsState[id].open) {
      var relBox = qs("unit-rel-" + id);
      if (relBox) {
        loadUnitRelations(u, relBox);
      }
    }
    if(qs("secuenciacionGrid").classList.contains("is-analysis")){
      analyzesecuenciacion();
    }
    refreshRelationsErrors();
  }

  function renderUnits(){
    var box = qs("unitsCards");
    box.innerHTML = "";
    qs("rightHint").style.display = state.units.length ? "none" : "block";

    state.units.forEach(u => {
      var relState = relationsState[u.id] || { open: false, html: "", hasErrors: false };
      relationsState[u.id] = relState;
      var isActive = (u.id === state.activeUnitId);
      var card = document.createElement("div");
      card.className = "card unit-card" + (u.id === state.activeUnitId ? " is-active" : "");
      card.style.padding = "10px";

      var top = document.createElement("div");
      top.style.display = "flex";
      top.style.gap = "8px";

      var input = document.createElement("input");
      input.value = u.name;
      input.placeholder = "Nombre de la unidad";
      input.style.flex = "1";
      input.oninput = e => {
        u.name = e.target.value;
        if(u.id === state.activeUnitId){
          qs("activeUnitName").textContent = u.name || "Sin nombre";
        }
        scheduleSave();
        if(qs("secuenciacionGrid").classList.contains("is-analysis")){
          analyzesecuenciacion();
        }
      };

      var btn = document.createElement("button");
      btn.textContent = (u.id === state.activeUnitId) ? "Seleccionada" : "Seleccionar";
      btn.disabled = (u.id === state.activeUnitId);
      btn.onclick = () => setActiveUnit(u.id);

      var delBtn = document.createElement("button");
      delBtn.textContent = "Borrar";
      delBtn.type = "button";
      delBtn.onclick = function(){
        if(!confirm("Borrar esta unidad?")) return;
        state.units = state.units.filter(x => x.id !== u.id);
        if(state.activeUnitId === u.id){
          state.activeUnitId = state.units.length ? state.units[0].id : null;
        }
        renderUnits();
        if(state.activeUnitId){
          setActiveUnit(state.activeUnitId);
        } else {
          setLeftLocked(true);
        }
        scheduleSave();
        refreshRelationsErrors();
        if(qs("secuenciacionGrid").classList.contains("is-analysis")){
          analyzesecuenciacion();
        }
      };

      top.append(input, btn, delBtn);
      card.appendChild(top);

      var tableScroll = document.createElement("div");
      tableScroll.className = "table-scroll";
      tableScroll.style.marginTop = "10px";

      var table = document.createElement("table");
      table.className = "nice-table";

      var thead = document.createElement("thead");
      var headRow = document.createElement("tr");
      var thSsbb = document.createElement("th");
      thSsbb.textContent = "SSBB";
      var thCe = document.createElement("th");
      thCe.textContent = "CE";
      headRow.append(thSsbb, thCe);
      thead.appendChild(headRow);

      var tbody = document.createElement("tbody");
      var bodyRow = document.createElement("tr");

      var tdSsbb = document.createElement("td");
      var ssbbWrap = document.createElement("div");
      ssbbWrap.className = "code-tag-list";
      if (u.ssbb.length === 0) {
        var emptySsbb = document.createElement("span");
        emptySsbb.className = "small-muted";
        emptySsbb.textContent = "Sin SSBB";
        ssbbWrap.appendChild(emptySsbb);
      } else {
        u.ssbb.forEach(code => {
          var tag = document.createElement("span");
          tag.className = "code-tag type-ssbb" + (isActive ? " is-selected" : "");
          tag.textContent = code;
          ssbbWrap.appendChild(tag);
        });
      }
      tdSsbb.appendChild(ssbbWrap);

      var tdCe = document.createElement("td");
      var ceWrap = document.createElement("div");
      ceWrap.className = "code-tag-list";
      if (u.cev.length === 0) {
        var emptyCe = document.createElement("span");
        emptyCe.className = "small-muted";
        emptyCe.textContent = "Sin CE";
        ceWrap.appendChild(emptyCe);
      } else {
        u.cev.forEach(code => {
          var tag = document.createElement("span");
          tag.className = "code-tag type-cev" + (isActive ? " is-selected" : "");
          tag.textContent = code;
          ceWrap.appendChild(tag);
        });
      }
      tdCe.appendChild(ceWrap);

      bodyRow.append(tdSsbb, tdCe);
      tbody.appendChild(bodyRow);

      table.append(thead, tbody);
      tableScroll.appendChild(table);
      card.appendChild(tableScroll);

      var relWrap = document.createElement("div");
      relWrap.style.marginTop = "8px";

      var relBtn = document.createElement("button");
      relBtn.type = "button";
      relBtn.className = "btn-small";
      relBtn.textContent = relState.open ? "v Relaciones" : "> Relaciones";

      var relBox = document.createElement("div");
      relBox.className = "table-scroll";
      relBox.style.marginTop = "8px";
      relBox.style.display = relState.open ? "block" : "none";
      relBox.id = "unit-rel-" + u.id;
      relBox.innerHTML = relState.html || '<div class="small-muted">Sin relaciones cargadas.</div>';

      if (relState.hasErrors !== true) {
        relState.hasErrors = false;
      }

      relBtn.onclick = function(){
        relState.open = !relState.open;
        setActiveUnit(u.id);
      };

      relWrap.append(relBtn, relBox);
      card.appendChild(relWrap);
      updateRelationsButton(u, relBox);
      box.appendChild(card);
    });
  }

  async function loadLeftCodes(){
    var u = activeUnit();
    if(!u || !state.subjectId) return;

    var fd = new FormData();
    fd.append("subject_id", state.subjectId);
    fd.append("mode", "secuenciacion");
    u.ssbb.forEach(c => fd.append("codes", c));
    u.cev.forEach(c => fd.append("codes", c));

    qs("leftStatus").textContent = "Cargando…";

    var res = await fetch("{% url 'generator:tables_search' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken() },
      body: fd
    });

    qs("leftStatus").textContent = "";

    var html = await res.text();
    var wrap = qs("leftCodes").querySelector(".codes-scroll");
    wrap.innerHTML = html;
    if (window.CodeResultsColumns){
      window.CodeResultsColumns.layout(wrap);
    }
  }

  async function loadUnitRelations(u, relBox){
    if(!state.subjectId) return;

    var codes = (u.ssbb || []).concat(u.cev || []);
    if(!codes.length){
      relBox.innerHTML = '<div class="small-muted">Selecciona codigos para ver relaciones.</div>';
      relationsState[u.id].html = relBox.innerHTML;
      relationsState[u.id].hasErrors = false;
      updateRelationsButton(u, relBox);
      return;
    }

    relBox.innerHTML = '<div class="small-muted">Cargando...</div>';

    var fd = new FormData();
    fd.append("subject_id", state.subjectId);
    fd.append("only_table2", "1");
    codes.forEach(c => fd.append("codes", c));

    var res = await fetch("{% url 'generator:tables_render' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken() },
      body: fd
    });

    var html = await res.text();
    relBox.innerHTML = html;
    relationsState[u.id].html = html;
    if (window.RelationsTable){
      window.RelationsTable.mark(relBox);
    }
    relationsState[u.id].hasErrors = !!relBox.querySelector('.relations-error');
    updateRelationsButton(u, relBox);
  }

  async function fetchUnitRelationsHtml(u){
    if(!state.subjectId) return "";
    var codes = (u.ssbb || []).concat(u.cev || []);
    if(!codes.length) return "";
    var key = codes.slice().sort().join("|");
    relationsState[u.id] = relationsState[u.id] || { open: false, html: "", hasErrors: false };
    if (relationsState[u.id].lastCodesKey === key && relationsState[u.id].html) {
      return relationsState[u.id].html;
    }
    var fd = new FormData();
    fd.append("subject_id", state.subjectId);
    fd.append("only_table2", "1");
    codes.forEach(c => fd.append("codes", c));
    var res = await fetch("{% url 'generator:tables_render' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken() },
      body: fd
    });
    var html = await res.text();
    relationsState[u.id].lastCodesKey = key;
    relationsState[u.id].html = html;
    return html;
  }

  async function refreshRelationsErrors(){
    if (relationsRefreshPromise) return relationsRefreshPromise;
    relationsRefreshPromise = (async function(){
    var needsRerender = false;
    var tasks = state.units.map(async u => {
      var html = await fetchUnitRelationsHtml(u);
      relationsState[u.id] = relationsState[u.id] || { open: false, html: "", hasErrors: false };
      var temp = document.createElement("div");
      temp.innerHTML = html;
      if (window.RelationsTable){
        window.RelationsTable.mark(temp);
      }
      relationsState[u.id].hasErrors = !!temp.querySelector('.relations-error');
      var relBox = qs("unit-rel-" + u.id);
      if (relBox){
        updateRelationsButton(u, relBox);
      } else {
        needsRerender = true;
      }
    });
    await Promise.all(tasks);
    if (needsRerender){
      renderUnits();
    }
    })();
    await relationsRefreshPromise;
    relationsRefreshPromise = null;
  }

  function updateRelationsButton(u, relBox){
    var relState = relationsState[u.id] || { open: false, hasErrors: false };
    var btn = relBox && relBox.parentElement ? relBox.parentElement.querySelector("button") : null;
    if (!btn) return;
    var arrow = relState.open ? "v " : "> ";
    var warn = relState.hasErrors ? " ⚠" : "";
    btn.textContent = arrow + "Relaciones" + warn;
    btn.classList.toggle("relations-warning", relState.hasErrors);
  }

  function createUnit(){
    if(!state.subjectId) return;
    if(isDemo && state.units.length >= DEMO_MAX_UNITS){
      alert("Modo demo: maximo " + DEMO_MAX_UNITS + " unidades.\\nEnvía un email a pabcadmon@gmail.com para más información.");
      return;
    }
    var u = { id: uid(), name:"", ssbb:[], cev:[] };
    state.units.push(u);
    setActiveUnit(u.id);
    scheduleSave();
    if(qs("secuenciacionGrid").classList.contains("is-analysis")){
      analyzesecuenciacion();
    }
  }

  async function loadsecuenciacions(){
    if(!state.subjectId) return;
    if(isDemo){
      var demoItems = state.secuenciacionName ? [{ id: "demo", name: state.secuenciacionName }] : [];
      rendersecuenciacionList(demoItems);
      syncsecuenciacionControls();
      return;
    }

    var url = "{% url 'generator:secuenciacion_plans' %}?subject_id=" + encodeURIComponent(state.subjectId) + "&_ts=" + Date.now();
    var res = await fetch(url, { cache: "no-store" });
    var data = await res.json();
    if(!data.ok) return;

    if(data.items.length){
      var storedPlanId = getStoredPlanId(state.subjectId);
      var match = data.items.find(x => String(x.id) === String(storedPlanId));
      var pick = match ? match.id : data.items[0].id;
      await loadsecuenciacion(pick);
      await refreshRelationsErrors();
    } else {
      state.secuenciacionId = null;
      state.secuenciacionName = "";
      syncPanelsVisibility();
      renderUnits();
      setLeftLocked(true);
      qs("analysisSummary").textContent = "";
      qs("missingSsbb").innerHTML = "";
      qs("missingCev").innerHTML = "";
      qs("analysisBox").style.display = "none";
    }
    rendersecuenciacionList(data.items || []);
  }

  async function loadsecuenciacion(id){
    if(!id) return;
    if(isDemo){
      state.secuenciacionId = id || "demo";
      syncPanelsVisibility();
      updateAnalysisTitle();
      renderUnits();
      if(state.activeUnitId){
        setActiveUnit(state.activeUnitId);
      } else {
        setLeftLocked(true);
      }
      syncsecuenciacionControls();
      return;
    }
    state.isHydrating = true;
    var url = "{% url 'generator:secuenciacion_plan_detail' 0 %}".replace("/0/", "/" + id + "/");
    var res = await fetch(url);
    var data = await res.json();
    if(data.ok){
      state.secuenciacionId = data.plan.id;
      state.secuenciacionName = data.plan.name || "";
      syncPanelsVisibility();
      updateAnalysisTitle();
      state.units = Array.isArray(data.plan.units) ? data.plan.units : [];
      state.activeUnitId = state.units.length ? state.units[0].id : null;
      renderUnits();
      if(state.activeUnitId){
        setActiveUnit(state.activeUnitId);
      } else {
        setLeftLocked(true);
      }
      await refreshRelationsErrors();
      setStoredPlanId(state.subjectId, state.secuenciacionId);
      setsecuenciacionStatus("Cargado");
      syncsecuenciacionControls();
      if(qs("secuenciacionGrid").classList.contains("is-analysis")){
        analyzesecuenciacion();
      }
    }
    state.isHydrating = false;
  }

  async function savesecuenciacion(){
    if(state.isHydrating || !state.subjectId) return;
    if(isDemo){
      writeDemoState();
      setsecuenciacionStatus("Demo: cambios locales");
      return;
    }
    var payload = {
      id: state.secuenciacionId,
      subject_id: state.subjectId,
      name: state.secuenciacionName || "secuenciación",
      units: state.units
    };

    var res = await fetch("{% url 'generator:secuenciacion_plan_save' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken()
      },
      body: JSON.stringify(payload)
    });
    var data = await res.json();
    if(data.ok){
      state.secuenciacionId = data.id;
      state.secuenciacionName = data.name;
      updateAnalysisTitle();
      setStoredPlanId(state.subjectId, data.id);
      setsecuenciacionStatus("Guardado");
      syncsecuenciacionControls();
      updateActivesecuenciacionButtonName(data.name);
    }
  }

  function scheduleSave(){
    if(state.isHydrating) return;
    if(isDemo){
      writeDemoState();
      setsecuenciacionStatus("Demo: cambios locales");
      return;
    }
    clearTimeout(state.saveTimer);
    setsecuenciacionStatus("Guardando...");
    state.saveTimer = setTimeout(savesecuenciacion, 500);
  }

  function createsecuenciacion(){
    if(!state.subjectId) return;
    opensecuenciacionModal("create");
  }

  function renamesecuenciacion(){
    if(!state.secuenciacionId) return;
    opensecuenciacionModal("rename");
  }

  async function deletesecuenciacion(){
    if(!state.secuenciacionId) return;
    if(isDemo){
      state.secuenciacionId = null;
      state.secuenciacionName = "";
      clearDemoState();
      syncPanelsVisibility();
      state.units = [];
      state.activeUnitId = null;
      renderUnits();
      setLeftLocked(true);
      setsecuenciacionStatus("Demo: sin guardar");
      rendersecuenciacionList([]);
      syncsecuenciacionControls();
      return;
    }
    var name = state.secuenciacionName || "este secuenciación";
    if(!confirm("Seguro que quieres borrar " + name + "?")) return;

    var url = "{% url 'generator:secuenciacion_plan_delete' 0 %}".replace("/0/", "/" + state.secuenciacionId + "/");
    var res = await fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken() }
    });
    var data = await res.json();
    if(!data.ok){
      setsecuenciacionStatus("No se pudo borrar");
      return;
    }

    state.secuenciacionId = null;
    state.secuenciacionName = "";
    clearDemoState();
    syncPanelsVisibility();
    state.units = [];
    state.activeUnitId = null;
    renderUnits();
    setLeftLocked(true);
    setStoredPlanId(state.subjectId, "");
    setsecuenciacionStatus("Borrado");
    syncsecuenciacionControls();
    await loadsecuenciacions();
  }

  qs("subjectSelect").onchange = async () => {
    state.subjectId = qs("subjectSelect").value;
    state.units = [];
    state.activeUnitId = null;
    state.secuenciacionId = null;
    state.secuenciacionName = "";
    relationsState = {};
    syncPanelsVisibility();
    if (isDemo) {
      applyDemoState(readDemoState());
    }
    setStoredSubjectId(state.subjectId);
    setStoredPlanId(state.subjectId, "");
    setLeftLocked(true);
    renderUnits();
    setsecuenciacionStatus("");
    syncsecuenciacionControls();
    showAnalysisPane(true);
    await loadsecuenciacions();
    await refreshRelationsErrors();
  };

  qs("createUnitBtn").onclick = createUnit;
  qs("createsecuenciacionBtn").onclick = createsecuenciacion;
  qs("deletesecuenciacionBtn").onclick = deletesecuenciacion;
  qs("renamesecuenciacionBtn").onclick = renamesecuenciacion;
  qs("analyzeBtn").onclick = analyzesecuenciacion;
  qs("analysisClose").onclick = function(){ showAnalysisPane(false); };

  var modalMode = "create";

  function opensecuenciacionModal(mode){
    modalMode = mode || "create";
    var suggested = "secuenciación " + new Date().toISOString().slice(0,10);
    var title = modalMode === "rename" ? "Cambiar nombre" : "Nuevo secuenciación";
    var action = modalMode === "rename" ? "Guardar" : "Crear";
    qs("secuenciacionModalTitle").textContent = title;
    qs("secuenciacionModalCreate").textContent = action;
    qs("secuenciacionModalName").value = modalMode === "rename" ? (state.secuenciacionName || suggested) : suggested;
    qs("secuenciacionModal").style.display = "flex";
    qs("secuenciacionModalName").focus();
  }

  async function analyzesecuenciacion(){
    if(!state.subjectId) return;
    showAnalysisPane(true);

    var payload = {
      subject_id: state.subjectId,
      units: state.units.map(u => ({
        name: u.name || "",
        ssbb: u.ssbb || [],
        cev: u.cev || []
      }))
    };

    var res = await fetch("{% url 'generator:secuenciacion_analyze' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken()
      },
      body: JSON.stringify(payload)
    });

    var data = await res.json();
    if(!data.ok){
      qs("analysisSummary").textContent = data.error || "No se pudo analizar.";
      qs("analysisBox").style.display = "block";
      return;
    }

    await refreshRelationsErrors();

    var hasAllSsbb = data.totals.used_ssbb >= data.totals.all_ssbb;
    var hasAllCev = data.totals.used_cev >= data.totals.all_cev;
    var hasErrors = !(hasAllSsbb && hasAllCev);

    var status = qs("analysisStatus");
    status.style.display = "block";
    status.textContent = hasErrors ? "Errores encontrados ⚠" : "No hay errores";
    status.classList.toggle("analysis-status-warning", hasErrors);
    status.classList.toggle("analysis-status-strong", hasErrors);

    var summary = qs("analysisSummary");
    summary.style.display = "block";
    summary.textContent =
      "SSBB usados: " + data.totals.used_ssbb + " / " + data.totals.all_ssbb +
      " | CEv usados: " + data.totals.used_cev + " / " + data.totals.all_cev +
      " | UD: " + data.totals.units;
    summary.classList.toggle("analysis-status-warning", hasErrors);

    var errors = [];
    if (!hasAllSsbb) errors.push("SSBB faltantes");
    if (!hasAllCev) errors.push("CEv faltantes");
    var relUnits = state.units
      .filter(u => relationsState[u.id] && relationsState[u.id].hasErrors)
      .map(u => u.name || "Sin nombre");
    if (relUnits.length) {
      errors.push("Relaciones incompletas en UD: " + relUnits.join(", "));
    }

    var errorsBox = qs("analysisErrors");
    if (errors.length) {
      errorsBox.style.display = "block";
      errorsBox.innerHTML = errors.map(function(item){
        return "<div>" + item + "</div>";
      }).join("");
      errorsBox.classList.add("analysis-errors-warning");
    } else {
      errorsBox.style.display = "none";
      errorsBox.textContent = "";
      errorsBox.classList.remove("analysis-errors-warning");
    }

    function renderTags(container, items, cls){
      container.innerHTML = "";
      if(!items || !items.length){
        var empty = document.createElement("span");
        empty.className = "small-muted";
        empty.textContent = "Sin elementos";
        container.appendChild(empty);
        return;
      }
      items.forEach(item => {
        var count = item.count || 0;
        var tag = document.createElement("span");
        tag.className = "code-tag " + cls;
        if(count > 1){
          tag.innerHTML = item.code + " <strong>(x" + count + ")</strong>";
        } else {
          tag.textContent = item.code;
        }
        container.appendChild(tag);
      });
    }

    renderTags(qs("usedSsbb"), data.used_ssbb || [], "type-ssbb");
    renderTags(qs("usedCev"), data.used_cev || [], "type-cev");
    renderTags(qs("missingSsbb"), data.missing_ssbb || [], "type-ssbb");
    renderTags(qs("missingCev"), data.missing_cev || [], "type-cev");

    qs("analysisBox").style.display = "block";
  }

  function closesecuenciacionModal(){
    qs("secuenciacionModal").style.display = "none";
  }

  async function createsecuenciacionFromModal(){
    if(!state.subjectId) return;
    var suggested = "secuenciación " + new Date().toISOString().slice(0,10);
    var name = (qs("secuenciacionModalName").value || "").trim() || suggested;
    closesecuenciacionModal();

    if(isDemo){
      if(modalMode === "rename"){
        if(!state.secuenciacionId) return;
        state.secuenciacionName = name;
        updateAnalysisTitle();
        updateActivesecuenciacionButtonName(name);
        writeDemoState();
        setsecuenciacionStatus("Demo: cambios locales");
        rendersecuenciacionList([{ id: "demo", name: state.secuenciacionName }]);
        syncsecuenciacionControls();
        return;
      }
      state.secuenciacionId = "demo";
      syncPanelsVisibility();
      state.secuenciacionName = name;
      writeDemoState();
      updateAnalysisTitle();
      state.units = [];
      state.activeUnitId = null;
      renderUnits();
      setLeftLocked(true);
      setsecuenciacionStatus("Demo: sin guardar");
      rendersecuenciacionList([{ id: "demo", name: state.secuenciacionName }]);
      syncsecuenciacionControls();
      return;
    }

    if(modalMode === "rename"){
      if(!state.secuenciacionId) return;
      state.secuenciacionName = name;
      updateAnalysisTitle();
      updateActivesecuenciacionButtonName(name);
      setsecuenciacionStatus("Renombrando...");
      await savesecuenciacion();
      await loadsecuenciacions();
      return;
    }

    state.secuenciacionId = null;
    state.secuenciacionName = name;
    syncPanelsVisibility();
    updateAnalysisTitle();
    state.units = [];
    state.activeUnitId = null;
    renderUnits();
    setLeftLocked(true);
    setStoredPlanId(state.subjectId, "");
    setsecuenciacionStatus("Nuevo secuenciación");
    syncsecuenciacionControls();
    await savesecuenciacion();
    await loadsecuenciacions();
  }

  qs("secuenciacionModalCancel").onclick = closesecuenciacionModal;
  qs("secuenciacionModalCreate").onclick = createsecuenciacionFromModal;
  qs("secuenciacionModal").querySelector(".modal-backdrop").onclick = closesecuenciacionModal;
  qs("secuenciacionModalName").addEventListener("keydown", function(e){
    if(e.key === "Enter"){ createsecuenciacionFromModal(); }
    if(e.key === "Escape"){ closesecuenciacionModal(); }
  });

  window.secuenciacionUI = {
    addFromButton(btn){
      var u = activeUnit();
      if(!u) return;
      var code = btn.dataset.code;
      var tipo = btn.dataset.tipo === "SSBB" ? u.ssbb : u.cev;
      var i = tipo.indexOf(code);
      if(isDemo && i === -1 && (u.ssbb.length + u.cev.length) >= DEMO_MAX_CODES){
        alert("Modo demo: maximo " + DEMO_MAX_CODES + " codigos por unidad.\\nEnvía un email a pabcadmon@gmail.com para más información.");
        return;
      }
      i === -1 ? tipo.push(code) : tipo.splice(i,1);
      renderUnits();
      var relBox = qs("unit-rel-" + u.id);
      if (relBox){
        loadUnitRelations(u, relBox);
      }
      refreshRelationsErrors();
      loadLeftCodes();
      scheduleSave();
      if(qs("secuenciacionGrid").classList.contains("is-analysis")){
        analyzesecuenciacion();
      }
    }
  };

  document.addEventListener("visibilitychange", function(){
    if(document.visibilityState === "hidden"){
      savesecuenciacion();
    } else {
      refreshRelationsErrors();
    }
  });

  window.addEventListener("beforeunload", function(){
    if (isDemo) {
      writeDemoState();
    }
  });

  var storedSubject = getStoredSubjectId();
  if(isDemo && demoSubjectId){
    qs("subjectSelect").value = demoSubjectId;
    qs("subjectSelect").disabled = true;
    qs("subjectSelect").onchange();
  } else if(storedSubject && qs("subjectSelect").querySelector("option[value='" + storedSubject + "']")){
    qs("subjectSelect").value = storedSubject;
    qs("subjectSelect").onchange();
  }
  syncPanelsVisibility();
  showAnalysisPane(true);
  syncsecuenciacionControls();
  refreshRelationsErrors();
})();
</script>

{% endblock %}

